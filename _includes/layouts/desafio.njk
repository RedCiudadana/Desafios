{% extends "src/base.njk" %}

{% block head %}
<title>{{ title }}</title>
{% endblock %}

{% block content %}

    <!-- Hero Section -->
    <div class="hero">
        <div class="row py-ct">
            <div class="col-lg-12">
                <h1 class="text-white">{{ title }}</h1>
            </div>
        </div>
    </div>

    <!-- Challenge Overview Section -->
    <div class="container my-5">
        <div class="row">
            <div class="col-lg-8">
                <div class="challenge-main-content">
                    <div class="challenge-image-wrapper mb-4">
                        <img class="challenge-detail-image" src="{{image}}" alt="{{ title }}">
                    </div>

                    <div class="challenge-description mb-4">
                        <h3 class="section-subtitle">Acerca del Desafío</h3>
                        <div class="description-content">
                            {{description | rmj | safe}}
                        </div>
                    </div>

                    <!-- Objectives -->
                    <div class="challenge-section mb-4">
                        <div class="section-header">
                            <img class="section-icon" src="/assets/img/iconos/DC_iconos-02.png" alt="Objetivos">
                            <h3 class="section-subtitle">Objetivos</h3>
                        </div>
                        <div class="section-content">
                            {{objetivos | rmj | safe}}
                        </div>
                    </div>

                    <!-- Evaluation Criteria -->
                    <div class="challenge-section mb-4">
                        <div class="section-header">
                            <img class="section-icon" src="/assets/img/iconos/DC_iconos-01.png" alt="Criterios">
                            <h3 class="section-subtitle">Criterios de Evaluación</h3>
                        </div>
                        <div class="section-content">
                            {{criterios | rmj | safe}}
                        </div>
                    </div>

                    <!-- Challenge Stages -->
                    <div class="challenge-section mb-4">
                        <h3 class="section-subtitle">Etapas del Reto</h3>
                        <div class="timeline">
                            <div class="timeline-item">
                                <div class="timeline-marker">1</div>
                                <div class="timeline-content">
                                    <h5>Ideación</h5>
                                    <p>Presentación de propuestas innovadoras que respondan al desafío planteado.</p>
                                    {% if stage1_videos %}
                                    <div class="stage-videos mt-3">
                                        <button class="btn btn-sm btn-outline-secondary toggle-videos" data-stage="1">
                                            <i class="fa-solid fa-play-circle"></i> Ver Videos de Exposiciones
                                        </button>
                                        <div class="videos-container" id="videos-stage-1" style="display: none;">
                                            <div class="row mt-3">
                                                {% for video in stage1_videos %}
                                                <div class="col-md-6 mb-3">
                                                    <div class="video-card">
                                                        <div class="video-wrapper">
                                                            <iframe src="{{video.url}}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                                        </div>
                                                        {% if video.title %}
                                                        <p class="video-title">{{video.title}}</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-marker">2</div>
                                <div class="timeline-content">
                                    <h5>Mentoría</h5>
                                    <p>Acompañamiento técnico y sesiones de orientación con expertos para refinar las propuestas.</p>
                                    {% if stage2_videos %}
                                    <div class="stage-videos mt-3">
                                        <button class="btn btn-sm btn-outline-secondary toggle-videos" data-stage="2">
                                            <i class="fa-solid fa-play-circle"></i> Ver Videos de Sesiones
                                        </button>
                                        <div class="videos-container" id="videos-stage-2" style="display: none;">
                                            <div class="row mt-3">
                                                {% for video in stage2_videos %}
                                                <div class="col-md-6 mb-3">
                                                    <div class="video-card">
                                                        <div class="video-wrapper">
                                                            <iframe src="{{video.url}}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                                        </div>
                                                        {% if video.title %}
                                                        <p class="video-title">{{video.title}}</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-marker">3</div>
                                <div class="timeline-content">
                                    <h5>Presentación Pública</h5>
                                    <p>Exposición de prototipos y soluciones ante un jurado de evaluadores.</p>
                                    {% if stage3_videos %}
                                    <div class="stage-videos mt-3">
                                        <button class="btn btn-sm btn-outline-secondary toggle-videos" data-stage="3">
                                            <i class="fa-solid fa-play-circle"></i> Ver Videos de Presentaciones
                                        </button>
                                        <div class="videos-container" id="videos-stage-3" style="display: none;">
                                            <div class="row mt-3">
                                                {% for video in stage3_videos %}
                                                <div class="col-md-6 mb-3">
                                                    <div class="video-card">
                                                        <div class="video-wrapper">
                                                            <iframe src="{{video.url}}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                                        </div>
                                                        {% if video.title %}
                                                        <p class="video-title">{{video.title}}</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-marker">4</div>
                                <div class="timeline-content">
                                    <h5>Premiación</h5>
                                    <p>Reconocimiento a las mejores propuestas y apoyo para su implementación.</p>
                                    {% if stage4_videos %}
                                    <div class="stage-videos mt-3">
                                        <button class="btn btn-sm btn-outline-secondary toggle-videos" data-stage="4">
                                            <i class="fa-solid fa-play-circle"></i> Ver Videos de Ceremonia
                                        </button>
                                        <div class="videos-container" id="videos-stage-4" style="display: none;">
                                            <div class="row mt-3">
                                                {% for video in stage4_videos %}
                                                <div class="col-md-6 mb-3">
                                                    <div class="video-card">
                                                        <div class="video-wrapper">
                                                            <iframe src="{{video.url}}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                                        </div>
                                                        {% if video.title %}
                                                        <p class="video-title">{{video.title}}</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Who Can Participate -->
                    <div class="challenge-section mb-4">
                        <h3 class="section-subtitle">¿Quiénes pueden participar?</h3>
                        <div class="participant-types">
                            <div class="participant-card">
                                <i class="fa-solid fa-users"></i>
                                <h5>Jóvenes y Estudiantes</h5>
                                <p>Con ideas innovadoras y ganas de generar cambio social.</p>
                            </div>
                            <div class="participant-card">
                                <i class="fa-solid fa-laptop-code"></i>
                                <h5>Tecnólogos y Desarrolladores</h5>
                                <p>Con habilidades técnicas para crear soluciones digitales.</p>
                            </div>
                            <div class="participant-card">
                                <i class="fa-solid fa-handshake"></i>
                                <h5>Organizaciones de la Sociedad Civil</h5>
                                <p>Comprometidas con el desarrollo local y la transparencia.</p>
                            </div>
                            <div class="participant-card">
                                <i class="fa-solid fa-lightbulb"></i>
                                <h5>Ciudadanía en General</h5>
                                <p>Cualquier persona con interés en contribuir a su comunidad.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="challenge-sidebar">
                    <!-- Prize -->
                    <div class="sidebar-card prize-card mb-4">
                        <div class="card-icon">
                            <img src="/assets/img/iconos/DC_iconos-03.png" alt="Premio">
                        </div>
                        <h4>Premio</h4>
                        <p class="prize-description">{{premio}}</p>
                    </div>

                    <!-- Deadline -->
                    <div class="sidebar-card deadline-card mb-4">
                        <h4>Fecha Límite</h4>
                        <div class="deadline-date">
                            <i class="fa-solid fa-calendar-days"></i>
                            <span>{{date | dateFormat('DD/MM/YYYY')}}</span>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="sidebar-card actions-card mb-4">
                        <h4>Acciones</h4>
                        <div class="action-buttons">
                            <a href="#registration-form" class="btn btn-primary btn-block mb-3">
                                <i class="fa-solid fa-user-plus"></i> Participar Ahora
                            </a>
                            <a href="{{link}}" class="btn btn-outline-primary btn-block mb-3" target="_blank">
                                <i class="fa-solid fa-download"></i> Descargar Detalles
                            </a>
                            <a href="{{link2}}" class="btn btn-outline-primary btn-block" target="_blank">
                                <i class="fa-solid fa-info-circle"></i> Más Información
                            </a>
                        </div>
                    </div>

                    <!-- Campaign Info -->
                    <div class="sidebar-card campaign-card mb-4">
                        <h4>Difusión y Alcance</h4>
                        <ul class="campaign-list">
                            <li><i class="fa-solid fa-bullhorn"></i> Campaña digital en redes sociales</li>
                            <li><i class="fa-solid fa-school"></i> Difusión en escuelas y universidades</li>
                            <li><i class="fa-solid fa-radio"></i> Promoción en radios comunitarias</li>
                            <li><i class="fa-solid fa-chalkboard-teacher"></i> Talleres de inspiración presenciales</li>
                        </ul>
                    </div>

                    <!-- Support -->
                    <div class="sidebar-card support-card">
                        <h4>Apoyo Incluido</h4>
                        <ul class="support-list">
                            <li><i class="fa-solid fa-check-circle"></i> Mentoría técnica especializada</li>
                            <li><i class="fa-solid fa-check-circle"></i> Acompañamiento durante el proceso</li>
                            <li><i class="fa-solid fa-check-circle"></i> Visibilidad pública del proyecto</li>
                            <li><i class="fa-solid fa-check-circle"></i> Integración a sandbox de desarrollo</li>
                        </ul>
                    </div>

                    <!-- Sponsors -->
                    {% if sponsors_image %}
                    <div class="sidebar-card sponsors-card">
                        <h4>Gracias al apoyo de:</h4>
                        <div class="sponsors-image-wrapper">
                            <img src="{{sponsors_image}}" alt="Sponsors" class="img-fluid">
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Form Section -->
    <div class="registration-section" id="registration-form">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="registration-card">
                        <h2 class="text-center mb-4">Inscríbete al Desafío</h2>
                        <p class="text-center mb-4">Completa el siguiente formulario para participar en este reto ciudadano. Nuestro equipo revisará tu solicitud y te contactará con los siguientes pasos.</p>

                        <form class="registration-form" id="registration-form-element" autocomplete="off">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="reg_name">Nombre Completo *</label>
                                        <input id="reg_name" name="entry.name" type="text" class="form-control" required placeholder="Tu nombre completo"/>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="reg_email">Correo Electrónico *</label>
                                        <input id="reg_email" name="entry.email" type="email" class="form-control" required placeholder="tu@email.com"/>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="reg_phone">Teléfono *</label>
                                        <input id="reg_phone" name="entry.phone" type="tel" class="form-control" required placeholder="Número de teléfono"/>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="reg_type">Tipo de Participante *</label>
                                        <select id="reg_type" name="entry.type" class="form-control" required>
                                            <option value="">Selecciona una opción</option>
                                            <option value="estudiante">Estudiante</option>
                                            <option value="profesional">Profesional / Tecnólogo</option>
                                            <option value="osc">Organización de la Sociedad Civil</option>
                                            <option value="ciudadano">Ciudadano/a</option>
                                            <option value="otro">Otro</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="reg_organization">Organización / Institución (opcional)</label>
                                <input id="reg_organization" name="entry.organization" type="text" class="form-control" placeholder="Nombre de tu organización o institución"/>
                            </div>

                            <div class="form-group">
                                <label for="reg_location">Municipio / Departamento *</label>
                                <input id="reg_location" name="entry.location" type="text" class="form-control" required placeholder="Tu ubicación"/>
                            </div>

                            <div class="form-group">
                                <label for="reg_idea">Describe brevemente tu idea o propuesta *</label>
                                <textarea id="reg_idea" name="entry.idea" class="form-control" required placeholder="Cuéntanos sobre tu propuesta de solución..." rows="5"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="reg_experience">Experiencia previa (opcional)</label>
                                <textarea id="reg_experience" name="entry.experience" class="form-control" placeholder="Experiencia relevante en proyectos similares..." rows="3"></textarea>
                            </div>

                            <div class="form-check mb-4">
                                <input type="checkbox" class="form-check-input" id="reg_terms" required>
                                <label class="form-check-label" for="reg_terms">
                                    Acepto las bases del desafío y autorizo el uso de mis datos para fines de la convocatoria *
                                </label>
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg btn-block" id="submit-btn">
                                <i class="fa-solid fa-paper-plane"></i> Enviar Inscripción
                            </button>
                            <div id="registration-loading" style="display:none;" class="text-center mt-3">
                                <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
                                <p>Enviando tu inscripción...</p>
                            </div>
                            <div id="registration-error" style="display:none;" class="alert alert-danger mt-3">
                                <i class="fa-solid fa-exclamation-circle"></i>
                                <span id="error-message">Hubo un error al enviar tu inscripción. Por favor, intenta de nuevo.</span>
                            </div>
                        </form>

                        <div id="registration-success" style="display:none;" class="alert alert-success mt-4 text-center">
                            <i class="fa-solid fa-check-circle fa-3x mb-3"></i>
                            <h4>¡Inscripción Exitosa!</h4>
                            <p>Gracias por tu interés en participar. Hemos recibido tu solicitud y nuestro equipo la revisará pronto. Te contactaremos con los siguientes pasos.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Challenges -->
    <div class="container my-5">
        <h2 class="text-center mb-4">Otros Desafíos Activos</h2>
        <div class="row">
            {% for desafio in collections.desafios | limit(3) %}
            {% if desafio.data.title != title %}
            <div class="col-md-4 mb-4">
                <div class="card challenge-card">
                    <a href="{{desafio.url}}">
                        <img src="{{desafio.data.image}}" class="card-img-top" alt="{{desafio.data.title}}">
                        <div class="card-body">
                            <h5 class="card-title">{{desafio.data.title}}</h5>
                            <p class="card-text">{{desafio.data.description | rmj | safe | truncate(150)}}</p>
                        </div>
                    </a>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

{% endblock %}

{% block body_javascripts %}
<script type="module">
    import { supabase } from '/assets/js/supabase-client.js';

    async function handleRegistrationSubmit(formData) {
        try {
            const { data, error } = await supabase
                .from('challenge_registrations')
                .insert([{
                    name: formData.name,
                    email: formData.email,
                    phone: formData.phone,
                    participant_type: formData.type,
                    organization: formData.organization || null,
                    location: formData.location,
                    idea: formData.idea,
                    experience: formData.experience || null,
                    challenge_name: formData.challenge
                }])
                .select();

            if (error) {
                console.error('Error submitting registration:', error);
                throw error;
            }

            document.getElementById('registration-success').style.display = 'block';
            document.getElementById('registration-form-element').style.display = 'none';

            return { success: true, data };
        } catch (error) {
            console.error('Registration error:', error);
            alert('Hubo un error al enviar tu inscripción. Por favor, intenta de nuevo.');
            return { success: false, error: error.message };
        }
    }

    document.getElementById('registration-form-element').addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = document.getElementById('submit-btn');
        const loadingDiv = document.getElementById('registration-loading');
        const errorDiv = document.getElementById('registration-error');

        submitBtn.disabled = true;
        loadingDiv.style.display = 'block';
        errorDiv.style.display = 'none';

        const formData = {
            name: document.getElementById('reg_name').value,
            email: document.getElementById('reg_email').value,
            phone: document.getElementById('reg_phone').value,
            type: document.getElementById('reg_type').value,
            organization: document.getElementById('reg_organization').value,
            location: document.getElementById('reg_location').value,
            idea: document.getElementById('reg_idea').value,
            experience: document.getElementById('reg_experience').value,
            challenge: "{{ title }}"
        };

        const result = await handleRegistrationSubmit(formData);

        loadingDiv.style.display = 'none';

        if (!result.success) {
            submitBtn.disabled = false;
            errorDiv.style.display = 'block';
        }
    });

    // Smooth scroll to registration form
    document.querySelectorAll('a[href="#registration-form"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector('#registration-form').scrollIntoView({
                behavior: 'smooth'
            });
        });
    });

    // Toggle videos for each stage
    document.querySelectorAll('.toggle-videos').forEach(button => {
        button.addEventListener('click', function() {
            const stage = this.getAttribute('data-stage');
            const videoContainer = document.getElementById('videos-stage-' + stage);
            const icon = this.querySelector('i');

            if (videoContainer.style.display === 'none') {
                videoContainer.style.display = 'block';
                icon.classList.remove('fa-play-circle');
                icon.classList.add('fa-times-circle');
                this.innerHTML = '<i class="fa-solid fa-times-circle"></i> Ocultar Videos';
            } else {
                videoContainer.style.display = 'none';
                icon.classList.remove('fa-times-circle');
                icon.classList.add('fa-play-circle');

                // Reset button text based on stage
                const texts = {
                    '1': 'Ver Videos de Exposiciones',
                    '2': 'Ver Videos de Sesiones',
                    '3': 'Ver Videos de Presentaciones',
                    '4': 'Ver Videos de Ceremonia'
                };
                this.innerHTML = '<i class="fa-solid fa-play-circle"></i> ' + texts[stage];
            }
        });
    });
</script>
{% endblock %}
